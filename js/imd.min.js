var serverAPI="http://opendatacommunities.org/sparql.json?query=";var arrayLA_auto=[];getLAList();var colorRamp=["#a80024","#eb000c","#ff6435","#fd9226","#ffc061","#ffe055","#fff675","#fffca3","#e9ff8e","#edffab"];var styleGeom={color:"#0000FF",weight:3,opacity:1,fillOpacity:0,clickable:false};var thisLAID=null;var thisLSOAGeom=null;var thisLSOAName=null;var thisLSOACode=null;var prevLSOAGeom=null;var thisWardName=null;var thisWardGeom=null;var prevWardGeom=null;var thisLAName=null;var thisLAGeom=null;var prevLAGeom=null;var prevPlace=null;var padOptions={padding:[150,150]};var zoomMode="LSOA";var areaTab=null;var idlayer=null;var arrayLAs=[];var arrayWards=[];var arrayLSOAs=[];var thisDomain="IMDDEC5";var decBandLabels=["10% most deprived","20% most deprived","30% most deprived","40% most deprived","50% most deprived","50% least deprived","40% least deprived","30% least deprived","20% least deprived","10% least deprived"];var arrayDomains=[{id:"IMDDEC5",img:"icons/imd_imd.png",label:"Index of Multiple Deprivation",decid:"IMDDEC5",odcid:"a. Index of Multiple Deprivation (IMD)"},{id:"INCDEC5",img:"icons/income-icon.png",label:"Income",decid:"INCDEC5",odcid:"b. Income Deprivation Domain"},{id:"EMPDEC5",img:"icons/employment-icon.png",label:"Employment",decid:"EMPDEC5",odcid:"c. Employment Deprivation Domain"},{id:"EDUDEC5",img:"icons/education-icon.png",label:"Education",decid:"EDUDEC5",odcid:"d. Education, Skills and Training Domain"},{id:"HDDEC5",img:"icons/health-icon.png",label:"Health",decid:"HDDEC5",odcid:"e. Health Deprivation and Disability Domain"},{id:"CRIDEC5",img:"icons/crime-icon.png",label:"Crime",decid:"CRIDEC5",odcid:"f. Crime Domain"},{id:"BARDEC5",img:"icons/barriers-to-housing-icon.png",label:"Barriers",decid:"BARDEC5",odcid:"g. Barriers to Housing and Services Domain"},{id:"ENVDEC5",img:"icons/living-environment-icon.png",label:"Living Environment",decid:"ENVDEC5",odcid:"h. Living Environment Deprivation Domain"},{id:"IDCDEC5",img:"icons/imd_aci.png",label:"IDACI",decid:"IDCDEC5",odcid:"i. Income Deprivation Affecting Children Index (IDACI)"},{id:"IDODEC5",img:"icons/imd_opi.png",label:"IDAOPI",decid:"IDODEC5",odcid:"j. Income Deprivation Affecting Older People Index (IDAOPI)"}];var thisDomainKey=arrayDomains[0]["odcid"].replace(/ /g,"_");var labelCorrected=thisDomainKey.replace(/_/g," ");labelCorrected=labelCorrected.substr(3,labelCorrected.length);$("#domainLabel").text(labelCorrected);function hideIMDLayer(){if(map.hasLayer(idlayer)){map.removeLayer(idlayer)}}function addIMDLayer(){if(map.hasLayer(idlayer)){map.removeLayer(idlayer)}idlayer=new L.TileLayer.WMS("http://maps.communities.gov.uk/geoserver/wms",{layers:"imd:IDL,admingeo:WD_2014_WGS84,admingeo:LAD_2014_WGS84",format:"image/png",transparent:true,styles:thisDomain+",,",version:"1.1.0",zIndex:2}).addTo(map);var a="http://maps.communities.gov.uk/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=imd:IDL&STYLE="+thisDomain+"&TRANSPARENT=true&legend_options=fontName:Times%20New%20Roman;fontAntiAliasing:true;fontColor:0x000033;fontSize:8;dpi:120";$("#mapLegend").empty();$('<p class="text-highlight">Map legend</p><p style="font-size:11px;">Deciles of deprivation</p><img src="'+a+'"/>').appendTo("#mapLegend")}function zoomToPlace(b){$('<span id="gserverq">Working...getting boundary data for selected location</span>').appendTo("#areaOverview");var a="http://maps.communities.gov.uk/geoserver/ows?service=WFS&version=2.0.0&request=GetFeature";a+="&typeName=imd:IDL&outputFormat=text/javascript";a+="&cql_filter=CONTAINS(the_geom,POINT%20("+b[0]+"%20"+b[1]+"))";$.ajax({url:a,dataType:"jsonp",jsonpCallback:"parseResponse",success:function(c){if(c.totalFeatures>0){if(map.hasLayer(thisWardGeom)){map.removeLayer(thisWardGeom)}if(map.hasLayer(thisLAGeom)){map.removeLayer(thisLAGeom)}if(map.hasLayer(prevLSOAGeom)){map.removeLayer(prevLSOAGeom)}if(map.hasLayer(prevWardGeom)){map.removeLayer(prevWardGeom)}if(map.hasLayer(prevLAGeom)){map.removeLayer(prevLAGeom)}thisLSOAGeom=L.geoJson(c.features,{style:styleGeom});prevLAGeom=thisLAGeom;prevWardGeom=thisWardGeom;prevLSOAGeom=thisLSOAGeom;thisPlace=L.marker(b);if(map.hasLayer(prevPlace)){map.removeLayer(prevPlace)}prevPlace=thisPlace;thisLSOAName=c.features[0]["properties"]["LSOA11NM"];thisLSOACode=c.features[0]["properties"]["LSOA11CD"];if(typeof arrayLSOAs[thisLSOACode]=="undefined"){arrayLSOAs[thisLSOACode]={name:thisLSOAName,poly:thisLSOAGeom}}getWardLA(b)}}})}function getWardLA(b){if(typeof arrayLSOAs[thisLSOACode]["inWard"]!="undefined"){thisWardCode=arrayLSOAs[thisLSOACode]["inWard"];thisWardName=arrayWards[thisWardCode]["name"];thisWardGeom=arrayWards[thisWardCode]["poly"];thisLAID=arrayLSOAs[thisLSOACode]["inLA"];thisLAName=arrayLAs[thisLAID]["name"];thisLAGeom=arrayLAs[thisLAID]["poly"];$("#gserverq").remove();getLSOAsInLA();return}var a="http://maps.communities.gov.uk/geoserver/ows?service=WFS&version=2.0.0&request=GetFeature";a+="&typeName=admingeo:WD_2014_WGS84&outputFormat=text/javascript";a+="&cql_filter=CONTAINS(the_geom,POINT%20("+b[0]+"%20"+b[1]+"))";$.ajax({url:a,dataType:"jsonp",jsonpCallback:"parseResponse",success:function(d){thisWardGeom=L.geoJson(d.features);var c="http://maps.communities.gov.uk/geoserver/ows?service=WFS&version=2.0.0&request=GetFeature";c+="&typeName=admingeo:LAD_2014_WGS84&outputFormat=text/javascript";c+="&cql_filter=CONTAINS(the_geom,POINT%20("+b[0]+"%20"+b[1]+"))";$.ajax({url:c,dataType:"jsonp",jsonpCallback:"parseResponse",success:function(e){thisLAGeom=L.geoJson(e.features);thisWardName=d.features[0]["properties"]["WD14NM"];thisWardCode=d.features[0]["properties"]["WD14CD"];thisLAName=d.features[0]["properties"]["LAD14NM"];thisLAID=d.features[0]["properties"]["LAD14CD"];if(typeof arrayWards[thisWardCode]=="undefined"){arrayWards[thisWardCode]={name:thisWardName,poly:thisWardGeom};arrayLSOAs[thisLSOACode]["inWard"]=thisWardCode;arrayLSOAs[thisLSOACode]["inLA"]=thisLAID}if(typeof arrayLAs[thisLAID]=="undefined"){arrayLAs[thisLAID]={name:thisLAName,LSOACount:0,LSOAs:[],poly:thisLAGeom}}$("#gserverq").remove();getLSOAsInLA()}})}})}function getLSOAsInLA(){$("#odcq").remove();if(typeof arrayLAs[thisLAID]["IMD"]=="undefined"||$.isEmptyObject(arrayLAs[thisLAID]["IMD"])){arrayLAs[thisLAID]["IMD"]=[];var b="PREFIX dcterms: <http://purl.org/dc/terms/>";b+="PREFIX owl: <http://www.w3.org/2002/07/owl#>";b+="PREFIX qb: <http://purl.org/linked-data/cube#>";b+="PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>";b+="PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>";b+="PREFIX skos: <http://www.w3.org/2004/02/skos/core#>";b+="PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>";b+="SELECT ?refAreaCode ?refAreaName ?domainLabel ?imdRank ?imdDecile ?lat ?lng WHERE {";b+="{  ?s <http://opendatacommunities.org/def/ontology/communities/societal_wellbeing/imd/indices> ?o  ; ";b+="      <http://opendatacommunities.org/def/ontology/geography/refArea> ?refAreaURI ; ";b+="      <http://opendatacommunities.org/def/ontology/communities/societal_wellbeing/imd/decObs> ?imdDecile .";b+="  ?o rdfs:label ?domainLabel . ";b+="  ?refAreaURI rdfs:label ?refAreaName ; ";b+="      skos:notation ?refAreaCode ;";b+="      <http://data.ordnancesurvey.co.uk/ontology/admingeo/inDistrict> ?parentURI ; ";b+="      <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?lat ;";b+="      <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?lng .";b+='  ?parentURI skos:notation "'+thisLAID+'" .';b+="} UNION {";b+="    ?s <http://opendatacommunities.org/def/ontology/communities/societal_wellbeing/imd/indices> ?o  ; ";b+="      <http://opendatacommunities.org/def/ontology/geography/refArea> ?refAreaURI ; ";b+="      <http://opendatacommunities.org/def/ontology/communities/societal_wellbeing/imd/rankObs> ?imdRank .";b+="      ?o rdfs:label ?domainLabel . ";b+="      ?refAreaURI rdfs:label ?refAreaName ; ";b+="          skos:notation ?refAreaCode ;";b+="          <http://data.ordnancesurvey.co.uk/ontology/admingeo/inDistrict> ?parentURI ; ";b+="          <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?lat ;";b+="          <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?lng .";b+='      ?parentURI skos:notation "'+thisLAID+'" .';b+=" }";b+="}  ORDER BY ?refAreaCode ?domainLabel";var e=1;$('<div id="odcq" class="odcLoader" style="z-index:10; width: 250px;"></div>').appendTo("#id-map");var d={lines:10,length:6,width:4,radius:6,scale:1,corners:1,color:"#000",opacity:0.25,rotate:0,direction:1,speed:1,trail:60,fps:20,zIndex:2000000000,top:"40%",left:"10%",shadow:false,hwaccel:false};var c="<table><tr>";c+='<td><div style="width:40px;" id="o_spinner"></div></td>';c+="<td>Working...getting data from OpenDataCommunities</td>";c+="</tr></table>";$(c).appendTo("#odcq");var f=document.getElementById("o_spinner");var g=new Spinner(d).spin(f);$("#odcq").position({my:"center center",at:"center center",of:"#id-map",collision:"none"});$("#areaOverview").hide();a(1,b)}else{drawTable()}function a(j,i){qryLSOAs=serverAPI+encodeURIComponent(i);qryLSOAs+="&page="+j+"&per_page=10000";qryLSOAs+="&commit=Execute+Query";$.ajax({url:qryLSOAs,dataType:"jsonp",success:function h(o){if(o==undefined){$("#odcq").remove();var p;return}var k=o.results["bindings"];if(k.length>0){for(var m=0;m<k.length;m++){var r=k[m]["refAreaCode"]["value"];var n=k[m]["refAreaName"]["value"];n=n.substr(0,n.indexOf(r)-1);thisIMDDomain=k[m]["domainLabel"]["value"].replace(/ /g,"_");if(typeof arrayLAs[thisLAID]["IMD"][thisIMDDomain]=="undefined"){arrayLAs[thisLAID]["IMD"][thisIMDDomain]={rank:[],decile:[]}}if(typeof k[m]["imdDecile"]!="undefined"){var l="decile";var q=parseInt(k[m]["imdDecile"]["value"])}if(typeof k[m]["imdRank"]!="undefined"){var l="rank";var q=parseInt(k[m]["imdRank"]["value"])}if(typeof arrayLAs[thisLAID]["IMD"][thisIMDDomain][l][r]=="undefined"){arrayLAs[thisLAID]["IMD"][thisIMDDomain][l][r]={value:q}}if(typeof arrayLAs[thisLAID]["LSOAs"][r]=="undefined"){arrayLAs[thisLAID]["LSOAs"][r]={name:n,pnt:[]};arrayLAs[thisLAID]["LSOACount"]++}if(k[m]["lat"]["value"]!=""){arrayLAs[thisLAID]["LSOAs"][r]["pnt"]["lat"]=parseFloat(k[m]["lat"]["value"]);arrayLAs[thisLAID]["LSOAs"][r]["pnt"]["lng"]=parseFloat(k[m]["lng"]["value"])}}j++;a(j,i)}else{$("#odcq").remove();drawTable()}},error:function(k,m){var l}})}}function getLAList(){var c="PREFIX dcterms: <http://purl.org/dc/terms/>";c+="PREFIX owl: <http://www.w3.org/2002/07/owl#>";c+="PREFIX qb: <http://purl.org/linked-data/cube#>";c+="PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>";c+="PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>";c+="PREFIX skos: <http://www.w3.org/2004/02/skos/core#>";c+="PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>";c+="PREFIX geo: <http://data.ordnancesurvey.co.uk/ontology/admingeo/>";c+="SELECT ?gssCode ?laname ?gssCodeCounty ?lanameCounty  ?gssCodeRegion ?lanameRegion ?lat ?lng";c+=" WHERE {";c+="  ?s a <http://opendatacommunities.org/def/local-government/LocalAuthority> ;";c+="      geo:gssCode ?gssCode ;";c+="      rdfs:label ?laname ;";c+="      <http://opendatacommunities.org/def/local-government/governs> ?osURI .";c+="  ?osURI <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?lat ;";c+="    <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?lng .";c+="      OPTIONAL {?s  <http://opendatacommunities.org/def/local-government/county> ?countyURI .";c+="               ?countyURI geo:gssCode ?gssCodeCounty ;";c+="                      rdfs:label ?lanameCounty .}";c+="      OPTIONAL {?s <http://statistics.data.gov.uk/def/administrative-geography/region> ?regionURI .";c+="                  ?regionURI skos:notation ?gssCodeRegion ;";c+="                      skos:prefLabel ?lanameRegion}.";c+='      FILTER(!regex(str(?s),"1","i")) ';c+="} ORDER BY ?laname";var a=serverAPI+encodeURIComponent(c);var d=1;a+="&page="+d+"&per_page=10000";a+="&commit=Execute+Query";$.ajax({url:a,dataType:"jsonp",success:function b(g){if(typeof g.results["bindings"]!="undefined"){var e=g.results["bindings"];for(var f=0;f<e.length;f++){arrayLA_auto.push({label:e[f]["laname"]["value"],lat:e[f]["lat"]["value"],lng:e[f]["lng"]["value"]})}}}})};