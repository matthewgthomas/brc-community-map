"use strict";(function(){var m=82;var i=[{index:0,name:"10% bands (deciles)",description:"",colours:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],breaks:[10,20,30,40,50,60,70,80,90,100]},{index:1,name:"20% bands (quintiles)",description:"",colours:["#d7191c","#fdae61","#ffffbf","#abd9e9","#2c7bb6"],breaks:[20,40,60,80,100]},{index:2,name:"Most deprived 25%, in 5% bands",description:"",colours:["#d73027","#fc8d59","#fee090","#e0f3f8","#91bfdb","#4575b4"],breaks:[5,10,15,20,25,100]}];i.forEach(function(t){var w=t.colours;var v=t.breaks;t.bands=[];for(var u=0;u<w.length;u++){t.bands.push({gt:u?v[u-1]:0,leq:v[u],colour:w[u]})}});var r=i[0];var p=0;function s(){d3.select("#legend").html("")}function g(t){return("000000"+t).slice(-6)}function q(t,u){for(var v=1;v<=10;v++){if(t<=u*v*10){return v}}}function n(t){t=t+"";if(t.length<=3){return t}else{return n(t.slice(0,-3))+","+t.slice(-3)}}function f(w,C){s();var z=w.zoneCodePrefix+g(C.properties[w.zoneCodeField]);var A=z+": "+w.zoneCodeToName[z];d3.select("#legend").append("div").text("âœ•").classed("close-x",true);d3.select("#legend").append("h2").text(A);d3.select("#legend").append("div").text("The middle column shows how this "+w.zoneType+" ranks on the overall "+w.shortName+" and on each domain, where 1 is the most deprived "+w.zoneType+" in "+w.country+" and "+n(w.numZones)+" is the least deprived. In the final column, deciles range from 1 (most deprived 10% of "+w.zoneType+"s) to 10 (least deprived 10%).");var B=d3.select("#legend").append("table");var v=B.append("thead").append("tr");var t=[{text:"Index/Domain",align:"left"},{text:"Rank",align:"right"},{text:"Decile",align:"right"}];t.forEach(function(D){v.append("th").style("text-align",D.align).text(D.text)});B.append("tbody").selectAll("tr").data(w.domains).enter().append("tr").call(y);var x=false;for(var u=0;u<w.domains.length;u++){x=x||C.properties["r"+u+"X100"]%100}if(x){d3.select("#legend").append("div").attr("class","non-integer-rank-note").append("i").text(w.nonIntegerRankNote)}function y(D){D.append("td").text(function(E){return E});D.append("td").style("text-align","right").text(function(G,F){var E=C.properties["r"+F+"X100"];return n((E-E%100)/100)+(E%100?".5*":"")});D.append("td").style("text-align","right").text(function(F,E){return q(C.properties["r"+E+"X100"],w.numZones)})}}function o(t,u){u.on("click",function(x){var w=u.queryRenderedFeatures(x.point,{layers:r.bands.map(function(z,y){return"scheme-"+r.index+"-band-"+y})});if(w.length){var v=w[0];u.setFilter("zone-highlight",["==",t.zoneCodeField,v.properties[t.zoneCodeField]]);f(t,v)}else{u.setFilter("zone-highlight",["==",t.zoneCodeField,-1]);s()}})}function k(t,u){u.addLayer({id:"zone-borders",type:"line",source:"zones","source-layer":t.zoneLayer,paint:{"line-color":"white","line-opacity":{stops:[[7,0],[9,0.1],[11,0.5],[14,0.7]]}}},"place-neighbourhood");u.addLayer({id:"zone-highlight",type:"line",source:"zones","source-layer":t.zoneLayer,paint:{"line-color":"#ffffff","line-opacity":1,"line-width":{stops:[[9,1],[11,3]]}},filter:["<","r0X100",0]},"place-neighbourhood")}function a(t){r.bands.forEach(function(v,u){t.removeLayer("scheme-"+r.index+"-band-"+u)})}function h(t,u){r.bands.forEach(function(y,w){var x=["all",[">","r"+p+"X100",y.gt*t.numZones],["<=","r"+p+"X100",y.leq*t.numZones]];if(u.getLayer("scheme-"+r.index+"-band-"+w)){u.setFilter("scheme-"+r.index+"-band-"+w,x)}else{var v={id:"scheme-"+r.index+"-band-"+w,type:"fill",source:"zones","source-layer":t.zoneLayer,paint:{"fill-color":y.colour,"fill-opacity":m/100},filter:x};u.addLayer(v,"zone-borders")}})}function l(t){var u=new mapboxgl.Map({container:"map",style:t.baseStyle,maxBounds:t.maxBounds,maxZoom:17,minZoom:t.minZoom});u.fitBounds(t.initialBounds);u.dragRotate.disable();u.touchZoomRotate.disableRotation();return u}function e(v,t,u,w){p=t;h(u,w)}function d(u,v){var t=d3.select("#domain-select").append("div");var w=t.selectAll("button").data(u.domains).enter().append("button").text(function(x){return x}).classed("highlight",function(y,x){return x==0}).on("click",function(y,x){e(y,x,u,v);w.classed("highlight",function(A,z){return x==z})})}function j(w,x,t){var u=d3.select("#colour-scheme-select").append("div");var v=u.selectAll("button").data(i).enter().append("button").text(function(y){return y.name}).classed("highlight",function(z,y){return y==0}).on("click",function(z,y){if(z!=r){a(x);r=z;console.log(z);h(w,x)}t.forEach(function(B,A){B.style("display",y==A?"inline":"none")});v.classed("highlight",function(B,A){return y==A})})}function b(x,z){var y=d3.scale.linear().range([0,250]);var t=[];var w=[];i.forEach(function(A,D){var F=d3.select("#colour-scale-legend-div").append("div").style("display",D?"none":"inline");t.push(F);var C=F.append("svg").attr("id","colour-scale-svg").attr("height",55).attr("width",250);var B=C.selectAll(".colour-scale-rect").data(A.bands).enter().append("rect").attr("class","colour-scale-rect").attr("x",function(G){return y(G.gt/100)}).attr("y",25).attr("width",function(G){return y(G.leq/100)-y(G.gt/100)}).attr("height",15).attr("fill",function(G){return G.colour});w.push(B);var E=[{text:"Most deprived",x:y(0),y:20,anchor:"start"},{text:"Least deprived",x:y(1),y:20,anchor:"end"}];E.forEach(function(G){C.append("text").attr("fill","#000").attr("x",G.x).attr("y",G.y).attr("text-anchor",G.anchor).text(G.text).attr("font-size","85%")})});var v=d3.select("#opacity-span").append("input").attr("type","range").attr("min",10).attr("value",m).on("change",function(){u(this.value/100)});u(v.attr("value")/100);function u(A){w.forEach(function(C){C.attr("fill-opacity",A)});for(var B=0;B<r.bands.length;B++){z.setPaintProperty("scheme-"+r.index+"-band-"+B,"fill-opacity",A)}}return t}function c(u,v){d3.select("#loading-msg").style("display","none");var w=new mapboxgl.Navigation({position:"top-left"});v.addControl(w);v.addSource("zones",{type:"vector",url:u.tileset});k(u,v);h(u,v);d(u,v);var t=b(u,v);j(u,v,t);o(u,v);d3.select("#selection-div").style("display","inline");d3.select("#legend").on("click",s)}d3.json("imdconfig.json",function(t,u){if(t){return console.warn(t)}mapboxgl.accessToken=u.mbAccessToken;var v=l(u);v.on("load",function(w){c(u,v)})})}());