function numberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function addVolsHeatmap(){if(map.hasLayer(volsHeatmap)&&map.removeLayer(volsHeatmap),"None"!==filterVolsType){var e=vols;"People"===filterVolsType&&(e=_.uniqBy(e,function(e){return e.id})),"All"!==filterVolsBasis&&(e=_.filter(e,function(e){return e.Basis===filterVolsBasis})),null!=filterDivision&&filterDivision.length>0&&(e=_.filter(e,function(e){return filterDivision.includes(e.Division)}));var a=_.map(e,function(e){return _.pick(e,"Latitude","Longitude")}),t=a.map(Object.values);volsHeatmap.options.size=$("#radius").slider("getValue"),volsHeatmap.setData(t),map.addLayer(volsHeatmap)}}function addStaffHeatmap(){if(map.hasLayer(staffHeatmap)&&map.removeLayer(staffHeatmap),"none"!==filterStaff){var e=staff;if("levels"===$("input[name=show_staff]:checked").val()){var a=$("#staff_level").slider("getValue");e=e.filter(function(e){return e.Level>=a[0]&e.Level<=a[1]})}null!=filterDivision&&filterDivision.length>0&&(e=_.filter(e,function(e){return filterDivision.includes(e.Division)})),$("#show_uko").prop("checked")||(e=_.filter(e,function(e){return 0==e.UKO})),$("#show_ssc").prop("checked")||(e=_.filter(e,function(e){return 0==e.SSC})),$("#show_rct").prop("checked")||(e=_.filter(e,function(e){return 0==e.RCT}));var t=_.map(e,function(e){return _.pick(e,"Latitude","Longitude")}),i=t.map(Object.values);staffHeatmap.options.size=$("#radius").slider("getValue"),staffHeatmap.setData(i),map.addLayer(staffHeatmap)}}function initServices(){services=services.map(function(e){return e.popup="<b>"+e.ServiceName+"</b><br/><br/><b>Services:</b><ul>"+e.Services+"</ul><b>Address:</b> "+e.Address+"<br/><br/><b>Phone number:</b> "+e.Telephone,e})}function addServices(){if(map.hasLayer(servicesLayer)&&map.removeLayer(servicesLayer),$("#show_servs").prop("checked")){var e=services;null!=filterDivision&&filterDivision.length>0&&(e=_.filter(e,function(e){return filterDivision.includes(e.ServiceType)}));for(var a=_.map(e,function(e){return _.pick(e,"Latitude","Longitude","popup")}),t=a.map(Object.values),i=new Array(t.length),o=0;o<t.length;o++)i[o]=new L.marker([t[o][0],t[o][1]],{icon:iconService}).bindPopup(t[o][2]);servicesLayer=L.layerGroup(i),servicesLayer.addTo(map)}}function initProperties(){props=props.map(function(e){return e.popup="<b>"+e.Description+"</b><br/><br/><b>UPC:</b> "+e.UPC+"<br/><b>Type:</b> "+e.Type+"<br/><br/><b>Address:</b> "+e.Address,e})}function addProperties(){if(map.hasLayer(propertiesLayer)&&map.removeLayer(propertiesLayer),$("#show_props").prop("checked")){var e=props;null!=filterDivision&&filterDivision.length>0&&(e=_.filter(e,function(e){return filterDivision.includes(e.Division)}));for(var a=_.map(e,function(e){return _.pick(e,"Latitude","Longitude","popup")}),t=a.map(Object.values),i=new Array(t.length),o=0;o<t.length;o++)i[o]=new L.marker([t[o][0],t[o][1]],{icon:iconProperty}).bindPopup(t[o][2]);propertiesLayer=L.layerGroup(i),propertiesLayer.addTo(map)}}function initShops(){shops=shops.map(function(e){return e.popup="<b>"+e.Description+"</b><br/><br/><b>UPC:</b> "+e.UPC+"<br/><b>Type:</b> "+e.Type+"<br/><br/><b>Address:</b> "+e.Address,e})}function addShops(){if(map.hasLayer(shopsLayer)&&map.removeLayer(shopsLayer),$("#show_shops").prop("checked")){for(var e=shops,a=_.map(e,function(e){return _.pick(e,"Latitude","Longitude","popup")}),t=a.map(Object.values),i=new Array(t.length),o=0;o<t.length;o++)i[o]=new L.marker([t[o][0],t[o][1]],{icon:iconShop}).bindPopup(t[o][2]);shopsLayer=L.layerGroup(i),shopsLayer.addTo(map)}}$(".division-select ").select2({data:divisionsOptions,placeholder:"Select services/divisions...",width:"style"}),$("#staff_level").slider({min:1,max:9,step:1,value:1,range:!0,tooltip:"show",ticks:[1,2,3,4,5,6,7,8,9],ticks_labels:["1","2","3","4","5","6","7","8","9"]}),$("#radius").slider({min:5e3,max:1e5,step:5e3,value:25e3,tooltip:"show"});var filterDivision=[];$(".list-group.checked-list-box .list-group-item-check").each(function(){function e(){var e=i.is(":checked");t.data("state",e?"on":"off"),t.find(".state-icon").removeClass().addClass("state-icon "+r[t.data("state")].icon),e?t.addClass(s+o+" selected"):t.removeClass(s+o+" selected")}function a(){t.data("checked")===!0&&i.prop("checked",!i.is(":checked")),e(),0===t.find(".state-icon").length&&t.prepend('<span class="state-icon '+r[t.data("state")].icon+'"></span>')}var t=$(this),i=$('<input type="checkbox" class="hidden" style="display: none" />'),o="success",s="button"===t.data("style")?"btn-":"list-group-item-",r={on:{icon:"fas fa-check-circle"},off:{icon:"far fa-circle"}};t.css("cursor","pointer"),t.append(i),t.on("click",function(){i.prop("checked",!i.is(":checked")),i.triggerHandler("change"),e()}),i.on("change",function(){e()}),a()}),$("#check-list-box").on("click",function(e){e.preventDefault(),filterDivision=[];var a=0;$("#check-list-box li.selected").each(function(e,t){filterDivision[a]=$(t).text(),a++}),addVolsHeatmap(),addStaffHeatmap(),addServices()});var map=L.map("map",{maxZoom:10,minZoom:5,zoomSnap:.25,zoomControl:!1,zoomAnimation:!1});L.control.zoom({position:"bottomright"}).addTo(map),map.fitBounds([[59.478568831926395,-10.8544921875],[49.82380908513249,2.021484375]]);var tiles_url="http://{s}.tile.osm.org/{z}/{x}/{y}.png";L.tileLayer(tiles_url,{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',edgeBufferTiles:2}).addTo(map);var sidebar=L.control.sidebar("sidebar").addTo(map),filterVolsBasis=document.getElementById("vol_options").value,filterVolsType=document.getElementById("show_vols").value,textureGreen=new Image;textureGreen.src="js/webgl-heatmap/green.png";var volsHeatmap=L.webGLHeatmap({size:25e3,opacity:.7,gradientTexture:textureGreen});map.addLayer(volsHeatmap);var filterStaff=document.getElementById("show_staff").value,filterStaffLevels=$("#staff_level").slider("getValue"),textureBlue=new Image;textureBlue.src="js/webgl-heatmap/deep-sea-gradient.png";var staffHeatmap=L.webGLHeatmap({size:25e3,opacity:.7,gradientTexture:textureBlue}),iconService=L.divIcon({html:'<i class="fa fa-plus" style="color: #D0021B"></i>',iconSize:[20,20],className:"awesomeIcon"}),servicesLayer,iconProperty=L.divIcon({html:'<i class="fa fa-building" style="color: #D0021B"></i>',iconSize:[20,20],className:"awesomeIcon"}),propertiesLayer,iconShop=L.divIcon({html:'<i class="fa fa-shopping-basket" style="color: #D0021B"></i>',iconSize:[20,20],className:"awesomeIcon"}),shopsLayer;$("#vol_options").change(function(){filterVolsBasis=$(this).val(),addVolsHeatmap(),addStaffHeatmap()}),$("input[name=show_vols]").change(function(){filterVolsType=$("input[name=show_vols]:checked").val(),addVolsHeatmap(),addStaffHeatmap()}),$("input[name=show_staff]").change(function(){filterStaff=$("input[name=show_staff]:checked").val(),addStaffHeatmap()}),$("#staff_level").change(function(){console.log("Slider values: ",$("#staff_level").slider("getValue")),addStaffHeatmap()}),$("#show_uko").change(function(){addStaffHeatmap()}),$("#show_ssc").change(function(){addStaffHeatmap()}),$("#show_rct").change(function(){addStaffHeatmap()}),$("#show_servs").change(function(){addServices()}),$("#show_props").change(function(){addProperties()}),$("#show_shops").change(function(){addShops()}),$("#tabpeople").on("click",function(){$("#staff_level").slider("relayout")}),$("#radius").on("slide",function(e){$("#radiusVal").text(e.value/1e3)}),$("#radius").on("change",function(e){$("#radiusVal").text(e.value/1e3),addVolsHeatmap(),addStaffHeatmap()}),$("input[name=externalradios]").change(function(){var e=$("input[name=externalradios]:checked").val();switch(console.log("Filter changed to ",e),e){case"none":hideIMDLayer();break;case"imd":addIMDLayer()}}),$(document).ready(function(){$('[data-toggle="popover"]').popover(),$("#tabhome").popover("show"),addVolsHeatmap(),addStaffHeatmap(),initServices(),addServices(),initProperties(),addProperties(),initShops(),addShops()});